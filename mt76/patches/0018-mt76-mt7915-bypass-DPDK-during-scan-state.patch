From 5a39f8b615a66273cfe9341e996d576c1486d17a Mon Sep 17 00:00:00 2001
From: Shayne Chen <shayne.chen@mediatek.com>
Date: Mon, 11 Apr 2022 00:51:38 +0800
Subject: [PATCH 3/3] mt76: mt7915: bypass DPDK during scan state

Signed-off-by: Shayne Chen <shayne.chen@mediatek.com>
---
 mt7915/mcu.c | 32 +++++++++++++++++++-------------
 1 file changed, 19 insertions(+), 13 deletions(-)

diff --git a/mt7915/mcu.c b/mt7915/mcu.c
index 73a11448..9d309cda 100644
--- a/mt7915/mcu.c
+++ b/mt7915/mcu.c
@@ -3417,6 +3417,7 @@ int mt7915_mcu_set_chan_info(struct mt7915_phy *phy, int cmd)
 	struct cfg80211_chan_def *chandef = &phy->mt76->chandef;
 	int freq1 = chandef->center_freq1;
 	bool ext_phy = phy != &dev->phy;
+	int ret = 0;
 	struct {
 		u8 control_ch;
 		u8 center_ch;
@@ -3446,24 +3447,22 @@ int mt7915_mcu_set_chan_info(struct mt7915_phy *phy, int cmd)
 
 #ifdef CONFIG_NL80211_TESTMODE
 	if (phy->mt76->test.tx_antenna_mask &&
-	    (phy->mt76->test.state == MT76_TM_STATE_TX_FRAMES ||
-	     phy->mt76->test.state == MT76_TM_STATE_RX_FRAMES ||
-	     phy->mt76->test.state == MT76_TM_STATE_TX_CONT)) {
+	    mt76_testmode_enabled(phy->mt76)) {
 		req.tx_streams_num = fls(phy->mt76->test.tx_antenna_mask);
 		req.rx_streams = phy->mt76->test.tx_antenna_mask;
-
-		if (ext_phy) {
-			req.tx_streams_num = 2;
-			req.rx_streams >>= 2;
-		}
 	}
 #endif
 
-	if (phy->mt76->hw->conf.flags & IEEE80211_CONF_OFFCHANNEL)
-		req.switch_reason = CH_SWITCH_SCAN_BYPASS_DPD;
-	else if ((chandef->chan->flags & IEEE80211_CHAN_RADAR) &&
-		 chandef->chan->dfs_state != NL80211_DFS_AVAILABLE)
+	if ((cmd == MCU_EXT_CMD(SET_RX_PATH) ||
+	     dev->mt76.hw->conf.flags & IEEE80211_CONF_MONITOR) &&
+	    !test_bit(MT76_SCANNING, &phy->mt76->state))
+		req.switch_reason = CH_SWITCH_NORMAL;
+	else if (!cfg80211_reg_can_beacon(phy->mt76->hw->wiphy, chandef,
+					  NL80211_IFTYPE_AP))
 		req.switch_reason = CH_SWITCH_DFS;
+	else if ((phy->mt76->hw->conf.flags & IEEE80211_CONF_OFFCHANNEL) ||
+		 test_bit(MT76_SCANNING, &phy->mt76->state))
+		req.switch_reason = CH_SWITCH_SCAN_BYPASS_DPD;
 	else
 		req.switch_reason = CH_SWITCH_NORMAL;
 
@@ -3476,7 +3475,14 @@ int mt7915_mcu_set_chan_info(struct mt7915_phy *phy, int cmd)
 		req.center_ch2 = ieee80211_frequency_to_channel(freq2);
 	}
 
-	return mt76_mcu_send_msg(&dev->mt76, cmd, &req, sizeof(req), true);
+	ret = mt76_mcu_send_msg(&dev->mt76, cmd, &req, sizeof(req), true);
+	if (ret)
+		return ret;
+
+	if (dev->dbdc_support && req.switch_reason == CH_SWITCH_NORMAL)
+		msleep(150);
+
+	return ret;
 }
 
 static int mt7915_mcu_set_eeprom_flash(struct mt7915_dev *dev)
-- 
2.32.0 (Apple Git-132)

